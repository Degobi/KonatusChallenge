<!DOCTYPE html>
<html>

<head>
    <title>Konatus Challenge</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap/dist/js/bootstrap.min.js"></script>
</head>

<body>
    <div>
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const ctx = document.getElementById('myChart').getContext('2d');;
        var chartData = '<%- data %>';

        new Chart(ctx, {
            type: 'bar',
            data: {
            labels: [
            'AC', 'AL', 'AM', 'AP', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
            'MG', 'MS', 'MT', 'PA', 'PB', 'PE', 'PI', 'PR', 'RJ', 'RN',
            'RO', 'RR', 'RS', 'SC', 'SE', 'SP', 'TO'
            ],
            datasets: [{
                    label: '# of Votes Candidate A',
                    data: chartData,
                    borderWidth: 1
                }, {
                    label: '# of Votes Candidate B',
                    data: chartData,
                    borderWidth: 1
                }]
            },
            options: {
                spanGaps: true,
                layout: {
                    padding: 100
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    </script>

    <div class="container">
        <h1>Importar Pesquisa Eleitoral</h1>
        <div class="row">
            <form class="form-group" method="post" enctype="multipart/form-data">
                <input type="file" name="xlsFile">
                <button class="btn btn-primary" type="submit">Enviar</button>
            </form>


            <form class="col-md-4" id="updateBaseForm" onsubmit="sendRequest(event); return false;">
                <div class="form-group">
                    <button type="submit" class="btn btn-primary" id="updateBaseButton">Atualizar Base</button>
                    <div class="spinner-border text-primary d-none" id="loading-indicator" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                </div>
            </form>

            
            <script>
                const updateBaseButton = document.getElementById('updateBaseButton');
                const loadingIndicator = document.getElementById('loading-indicator');
            
                async function sendRequest(event) {
                    event.preventDefault();
                    updateBaseButton.disabled = true;
                    loadingIndicator.classList.remove('d-none');
            
                    try {
                        const response = await fetch('/update-base', { method: 'POST' });
            
                        if (response.ok) {
                            const message = await response.text();
                            showMessage(message);
                        }
                    } catch (error) {
                        showMessage("Ocorreu um erro durante a atualização. Tente novamente mais tarde.", true);
                    } finally {
                        updateBaseButton.disabled = false;
                        loadingIndicator.classList.add('d-none');
                    }
                }

                function showMessage(message, isError = false) {
                    const alertContainer = document.getElementById('alert-container');
                    const alertClass = isError ? 'alert-danger' : 'alert-success';
                    alertContainer.innerHTML = `
                        <div class="alert ${alertClass}" role="alert">
                            ${message}
                        </div>
                    `;

                    setTimeout(clearMessage, 5000);

                    function clearMessage() {
                        alertContainer.innerHTML = '';
                    }
            }

            </script>

            <div id="alert-container"></div>

        </div>
    </div>


</body>

</html>